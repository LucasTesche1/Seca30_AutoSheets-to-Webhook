/**
 * CONFIGURAÇÕES DA UMBLERTALK
 */
const UMBLER_CONFIG = {
  url: "https://app-utalk.umbler.com/api/v1/messages/simplified/",
  fromPhone: "+5561993133245",
  organizationId: "aYVFlxsdK39dR3qp",
  token: "gsheets-2026-02-06-2094-02-24--3A185F99EE642369A819C7FD6CDAAE935761D5EBB253075294D4A475D7D18374"
};

const DIAS_EXCECAO = [1, 192, 283, 108, 143, 206, 227, 234, 248, 262, 297, 318, 353, 360];

function substituiVariavelNomeAluna(mensagem, nomeCompleto){
  return mensagem.replace("${nome_aluna}", nomeCompleto.split(" ")[0])
}

/**
 * Registra logs normais de envio
 */
function registrarLog(nome, contato, dias, mensagem, tipo, status) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var abaLog = ss.getSheetByName("Log_Envios");
  
  if (!abaLog) {
    abaLog = ss.insertSheet("Log_Envios");
    abaLog.appendRow(["Data/Hora", "Nome", "Contato", "Dias", "Mensagem", "Tipo", "Status"]);
    abaLog.getRange("A1:G1").setFontWeight("bold").setBackground("#f3f3f3");
  }
  
  abaLog.appendRow([new Date(), nome, contato, dias, mensagem, tipo, status]);
}

/**
 * Registra casos que caíram na lista de exceção
 */
function registrarAtencao(nome, contato, dias, mensagem, tipo) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var abaAtencao = ss.getSheetByName("REQUER_ATENCAO");
  
  if (!abaAtencao) {
    abaAtencao = ss.insertSheet("REQUER_ATENCAO");
    abaAtencao.appendRow(["Data/Hora", "Nome", "Contato", "Dias", "Mensagem", "Tipo", "Alerta"]);
    abaAtencao.getRange("A1:G1").setFontWeight("bold").setBackground("#ffe5e5"); // Vermelho claro para destaque
  }
  
  abaAtencao.appendRow([new Date(), nome, contato, dias, mensagem, tipo, "REQUER ATENÇÃO"]);
}

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('✈Enviar UmblerTalk')
      .addItem('Enviar Linha Selecionada (Single)', 'enviarApenasLinhaSelecionada')
      .addSeparator()
      .addItem('Enviar Todas as Linhas (Bulk)', 'iteraExcelEnviaWebhookUmbler')
      .addToUi();
}

function enviaHojeOuNao(dias, quinzenal, mensal) {
  // A verificação de exceção agora é tratada individualmente nas funções de loop 
  // para permitir o registro no log específico antes do 'continue/return'
  if (quinzenal) {
    var aptoPara14dias = (dias - 17) >= 0 && (dias - 17) % 14 === 0;
    return aptoPara14dias;
  } else if (mensal) {
    var aptoPara28dias = (dias - 17) >= 0 && (dias - 17) % 28 === 0;
    return aptoPara28dias;
  } else {
    return true;
  }
}

/**
 * Função BULK
 */
function iteraExcelEnviaWebhookUmbler() {
  var planilha = SpreadsheetApp.getActiveSpreadsheet();
  var aba = planilha.getSheetByName("TESTCASE");
  var dados = aba.getDataRange().getValues();

  var contagemProcessados = 0;
  var atualizacoesStatus = [];

  planilha.toast("Iniciando envio via UmblerTalk...", "Automação", 3);

  for (var i = 1; i < dados.length; i++) {
    var dadosLinha = dados[i];

    var nome           = dadosLinha[1];   // Coluna B
    var dias           = dadosLinha[4];   // Coluna E
    var msgNaoTratada       = dadosLinha[8];   // Coluna I
    var contato        = dadosLinha[9];   // Coluna J
    var statusCheckbox = dadosLinha[10];  // Coluna K
    var quinzenal      = dadosLinha[12];  // Coluna M
    var mensal         = dadosLinha[13];  // Coluna N
    var mensagem = substituiVariavelNomeAluna(msgNaoTratada, nome);

    // --- VERIFICAÇÃO DE EXCEÇÃO ---
    if (DIAS_EXCECAO.includes(Number(dias))) {
      registrarAtencao(nome, contato, dias, mensagem, "Bulk");
      atualizacoesStatus.push([statusCheckbox]); // Mantém o status atual
      continue;
    }

    if (enviaHojeOuNao(dias, quinzenal, mensal) == false) {
      atualizacoesStatus.push([statusCheckbox]);
      continue;
    }

    if (statusCheckbox === true || !nome) {
      atualizacoesStatus.push([statusCheckbox]);
      continue;
    }

    if (!mensagem || !contato) {
      atualizacoesStatus.push([false]);
      continue;
    }

    var telefoneLimpo = "+" + contato.toString().replace(/\D/g, '');

    var payload = {
      toPhone: telefoneLimpo,
      fromPhone: UMBLER_CONFIG.fromPhone,
      organizationId: UMBLER_CONFIG.organizationId,
      message: mensagem,
      file: null,
      skipReassign: false,
      contactName: nome || ""
    };

    var opcoes = {
      method: "post",
      contentType: "application/json",
      headers: { Authorization: "Bearer " + UMBLER_CONFIG.token },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    Utilities.sleep(1000);
    try {
      var response = UrlFetchApp.fetch(UMBLER_CONFIG.url, opcoes);
      var statusCode = response.getResponseCode();

      if (statusCode === 200 || statusCode === 201) {
        registrarLog(nome, telefoneLimpo, dias, mensagem, "Bulk", "✅Enviado");
        contagemProcessados++;
        atualizacoesStatus.push([true]);
      } else {
        registrarLog(nome, telefoneLimpo, dias, mensagem, "Bulk", "Erro HTTP " + statusCode);
        atualizacoesStatus.push([false]);
      }
    } catch (e) {
      console.log("Erro na linha " + (i + 1) + ": " + e);
      atualizacoesStatus.push([false]);
    }
  }

  if (atualizacoesStatus.length > 0) {
    aba.getRange(2, 11, atualizacoesStatus.length, 1).setValues(atualizacoesStatus);
  }
  planilha.toast("Finalizado! " + contagemProcessados + " mensagens enviadas ✅", "Sucesso", 10);
}

/**
 * Função SINGLE
 */
function enviarApenasLinhaSelecionada() {
  var planilha = SpreadsheetApp.getActiveSpreadsheet();
  var aba = planilha.getActiveSheet();
  var linhaAtiva = aba.getActiveCell().getRow();

  if (linhaAtiva === 1) {
    SpreadsheetApp.getUi().alert("❌ Erro: Selecione uma linha de dados.");
    return;
  }

  var dadosLinha = aba.getRange(linhaAtiva, 1, 1, 14).getValues()[0];

  var nome           = dadosLinha[1]; 
  var dias           = dadosLinha[4]; 
  var mensagem       = dadosLinha[8]; 
  var contato        = dadosLinha[9]; 
  var statusCheckbox = dadosLinha[10]; 
  var quinzenal      = dadosLinha[12]; 
  var mensal         = dadosLinha[13]; 

  // --- VERIFICAÇÃO DE EXCEÇÃO ---
  if (DIAS_EXCECAO.includes(Number(dias))) {
    registrarAtencao(nome, contato, dias, mensagem, "Single");
    SpreadsheetApp.getUi().alert("⚠️ Dia Crítico detectado (" + dias + "). Movido para aba REQUER_ATENCAO.");
    return;
  }

  if (enviaHojeOuNao(dias, quinzenal, mensal) === false) {
    SpreadsheetApp.getUi().alert("⚠️ Aviso: Esta linha não cumpre os requisitos de data.");
    return;
  }

  if (statusCheckbox === true) {
    planilha.toast("Esta linha já consta como enviada ✅", "Aviso", 4);
    return;
  }

  var telefoneLimpo = "+" + contato.toString().replace(/\D/g, '');

  var payload = {
    toPhone: telefoneLimpo,
    fromPhone: UMBLER_CONFIG.fromPhone,
    organizationId: UMBLER_CONFIG.organizationId,
    message: mensagem,
    file: null,
    skipReassign: false,
    contactName: nome || ""
  };

  var opcoes = {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + UMBLER_CONFIG.token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    planilha.toast("Enviando...", "UmblerTalk", 2);
    var response = UrlFetchApp.fetch(UMBLER_CONFIG.url, opcoes);
    var statusCode = response.getResponseCode();

    if (statusCode === 200 || statusCode === 201) {
      registrarLog(nome, telefoneLimpo, dias, mensagem, "Single", "✅Enviado");
      aba.getRange(linhaAtiva, 11).setValue(true); 
      planilha.toast("Enviada com sucesso! ✅", "Sucesso", 5);
    } else {
      registrarLog(nome, telefoneLimpo, dias, mensagem, "Single", "Erro HTTP " + statusCode);
    }
  } catch (e) {
    SpreadsheetApp.getUi().alert("Erro técnico: " + e.toString());
  }
}
