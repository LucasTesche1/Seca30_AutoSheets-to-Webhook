/**
 * CONFIGURAÇÕES DA UMBLERTALK
 */
const UMBLER_CONFIG = {
  url: "https://app-utalk.umbler.com/api/v1/messages/simplified/",
  fromPhone: "+5561993133245",
  organizationId: "aYVFlxsdK39dR3qp",
  token: "gsheets-2026-02-06-2094-02-24--3A185F99EE642369A819C7FD6CDAAE935761D5EBB253075294D4A475D7D18374"
};

function registrarLog(nome, contato, dias, mensagem, tipo, status) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var abaLog = ss.getSheetByName("Log_Envios");
  
  if (!abaLog) {
    abaLog = ss.insertSheet("Log_Envios");
    abaLog.appendRow(["Data/Hora", "Nome", "Contato", "Dias", "Mensagem", "Tipo", "Status"]);
    abaLog.getRange("A1:G1").setFontWeight("bold").setBackground("#f3f3f3");
  }
  
  abaLog.appendRow([new Date(), nome, contato, dias, mensagem, tipo, status]);
}

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('✈Enviar UmblerTalk')
      .addItem('Enviar Linha Selecionada (Single)', 'enviarApenasLinhaSelecionada')
      .addSeparator()
      .addItem('Enviar Todas as Linhas (Bulk)', 'iteraExcelEnviaWebhookUmbler')
      .addToUi();
}


function enviaHojeOuNao(dias, quinzenal, mensal){

  if(quinzenal){
    var aptoPara14dias = (dias - 17) >= 0 && (dias - 17) % 14 === 0;
    return aptoPara14dias;
  }else if(mensal){
    var aptoPara28dias = (dias - 17) >= 0 && (dias - 17) % 28 === 0;
    return aptoPara28dias;
  }else{
    return true
  }
}

/**
 * Função BULK: Itera por toda a aba com a nova validação lógica.
 */
function iteraExcelEnviaWebhookUmbler() {
  var planilha = SpreadsheetApp.getActiveSpreadsheet();
  var aba = planilha.getSheetByName("TESTCASE");
  var dados = aba.getDataRange().getValues();

  var contagemProcessados = 0;
  var atualizacoesStatus = [];

  planilha.toast("Iniciando envio via UmblerTalk...", "Automação", 3);

  for (var i = 1; i < dados.length; i++) {
    var dadosLinha = dados[i];

    // Mapeamento de Colunas
    var nome          = dadosLinha[1];   // Coluna B
    var dias          = dadosLinha[4];   // Coluna E
    var mensagem      = dadosLinha[8];   // Coluna I
    var contato       = dadosLinha[9];   // Coluna J
    var statusCheckbox = dadosLinha[10]; // Coluna K (Se já foi enviado)
    var quinzenal = dadosLinha[12]; //Coluna M
    var mensal = dadosLinha[13]; //Coluna N
  
    // Se já foi enviado (K=true), se o nome está vazio, ou se NÃO passou na validação lógica: PULA.
    if(enviaHojeOuNao(dias, quinzenal, mensal) == false){
      continue;
    };

    if (statusCheckbox === true || !nome) {
      atualizacoesStatus.push([statusCheckbox]); // Mantém o status atual na memória
      continue;
    }

    // Validação de dados básicos
    if (!mensagem || !contato) {
      atualizacoesStatus.push([false]);
      continue;
    }

    var telefoneLimpo = "+"+ contato.toString().replace(/\D/g, '');

    var payload = {
      toPhone: telefoneLimpo,
      fromPhone: UMBLER_CONFIG.fromPhone,
      organizationId: UMBLER_CONFIG.organizationId,
      message: mensagem,
      file: null,
      skipReassign: false,
      contactName: nome || ""
    };

    var opcoes = {
      method: "post",
      contentType: "application/json",
      headers: { Authorization: "Bearer " + UMBLER_CONFIG.token },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    Utilities.sleep(1000)
    try {
      var response = UrlFetchApp.fetch(UMBLER_CONFIG.url, opcoes);
      var statusCode = response.getResponseCode();

      if (statusCode === 200 || statusCode === 201) {
        registrarLog(nome, telefoneLimpo, dias, mensagem, "Bulk", "✅Enviado");
        contagemProcessados++;
        atualizacoesStatus.push([true]);
      } else {
        registrarLog(nome, telefoneLimpo, dias, mensagem, "Bulk", "Erro HTTP " + statusCode);
        atualizacoesStatus.push([false]);
      }

      if (contagemProcessados % 5 === 0) {
        planilha.toast("Enviados: " + contagemProcessados, "Progresso Umbler", 2);
      }

    } catch (e) {
      console.log("Erro na linha " + (i + 1) + ": " + e);
      atualizacoesStatus.push([false]);
    }
  }

  if (atualizacoesStatus.length > 0) {
    aba.getRange(2, 11, atualizacoesStatus.length, 1).setValues(atualizacoesStatus);
  }

  planilha.toast("Finalizado! " + contagemProcessados + " mensagens enviadas ✅", "Sucesso", 10);
}

/**
 * Função SINGLE: Adaptada com a mesma validação para evitar disparos manuais errados.
 */
/**
 * Função SINGLE: Adaptada para usar a mesma lógica de validação da função Bulk.
 */
function enviarApenasLinhaSelecionada() {
  var planilha = SpreadsheetApp.getActiveSpreadsheet();
  var aba = planilha.getActiveSheet();
  var linhaAtiva = aba.getActiveCell().getRow();

  // Impede execução no cabeçalho
  if (linhaAtiva === 1) {
    SpreadsheetApp.getUi().alert("❌ Erro: Selecione uma linha de dados (abaixo do cabeçalho).");
    return;
  }

  // Pega os dados da linha (Colunas A até N - 14 colunas para garantir que temos quinzenal/mensal)
  var dadosLinha = aba.getRange(linhaAtiva, 1, 1, 14).getValues()[0];

  // Mapeamento idêntico ao Bulk
  var nome           = dadosLinha[1];   // Coluna B
  var dias           = dadosLinha[4];   // Coluna E
  var mensagem       = dadosLinha[8];   // Coluna I
  var contato        = dadosLinha[9];   // Coluna J
  var statusCheckbox = dadosLinha[10];  // Coluna K
  var quinzenal      = dadosLinha[12];  // Coluna M
  var mensal         = dadosLinha[13];  // Coluna N

  // 1. Validação de Regra de Negócio (Mesma da Bulk)
  if (enviaHojeOuNao(dias, quinzenal, mensal) === false) {
    SpreadsheetApp.getUi().alert("⚠️ Aviso: Esta linha não cumpre os requisitos de data (Quinzenal/Mensal).");
    return;
  }

  // 2. Validação de Status e Nome
  if (statusCheckbox === true) {
    planilha.toast("Esta linha já consta como enviada ✅", "Aviso", 4);
    return;
  }

  if (!nome || !mensagem || !contato) {
    SpreadsheetApp.getUi().alert("❌ Erro: Dados incompletos (Nome, Mensagem ou Contato faltando).");
    return;
  }

  // Preparação do Envio
  var telefoneLimpo = "+" + contato.toString().replace(/\D/g, '');

  var payload = {
    toPhone: telefoneLimpo,
    fromPhone: UMBLER_CONFIG.fromPhone,
    organizationId: UMBLER_CONFIG.organizationId,
    message: mensagem,
    file: null,
    skipReassign: false,
    contactName: nome || ""
  };

  var opcoes = {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + UMBLER_CONFIG.token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    planilha.toast("Enviando mensagem individual...", "UmblerTalk", 2);
    var response = UrlFetchApp.fetch(UMBLER_CONFIG.url, opcoes);
    var statusCode = response.getResponseCode();

    if (statusCode === 200 || statusCode === 201) {
      // Registra o log e marca o checkbox na coluna K (11)
      registrarLog(nome, telefoneLimpo, dias, mensagem, "Single", "✅Enviado");
      aba.getRange(linhaAtiva, 11).setValue(true); 
      planilha.toast("Enviada com sucesso! ✅", "Sucesso", 5);
    } else {
      var erroMsg = response.getContentText();
      registrarLog(nome, telefoneLimpo, dias, mensagem, "Single", "Erro HTTP " + statusCode);
      SpreadsheetApp.getUi().alert("Erro na Umbler (Status " + statusCode + "): " + erroMsg);
    }
  } catch (e) {
    SpreadsheetApp.getUi().alert("Erro técnico: " + e.toString());
  }
}
